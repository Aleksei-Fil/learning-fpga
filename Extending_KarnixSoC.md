# Расширение и доработка СнК "Карно"

Синтезируемая Система-на-Кристалле "Карно" представляет собой код написанные на HDL языке SpinalHDL с включениями на языке Verilog.
Основная цель создания СнК "Карно" - продемонстрировать потенциал недорогих микросхем ПЛИС как замену микроконтроллерам с гибкой системой настройки аппаратуры под задачу.
Получить синтезируемую систему близкую по возможностям к микроконтроллерам среднего звена (GD32F3xx, STM32F3xx и т.д.) и использовать её для задач промышленной и домашней автоматизации: устройства сбора информации, устройства АСУ ТП.

На данный момент СнК "Карно" функционирует только на ПЛИС Lattice ECP5, что является сильным ограничителем для её применения.

Исходные коды и описание СнК "Карно" (KarnixSoC): https://github.com/pointcheck/KarnixSOC

Проект платы "Карно" с ПЛИС Lattice ECP5: https://github.com/Fabmicro-LLC/Karnix_ASB-254

## Список задач по расширению аппаратных возможностей СнК "Карно"

### 1. Портировать СнК "Карно" на другие ПЛИС

Цель: обеспечить покрытие большого количества дешевых и популярных ПЛИС.

  1.1. Gowin [GW1NR-9K](https://www.gowinsemi.com/en/product/detail/49/), плата TangNano-9K.
  
  1.2. Gowin [GW2A](https://www.gowinsemi.com/en/product/detail/38/), плата TangPrimer-20K.
  
  1.3. AMD Zynq UltraScale+ ([XCZU2CG-1SFVC784E](https://www.digchip.com/datasheets/parts/datasheet/2/534/XCZU2CG-1SFVC784E-pdf.php)), плата [ALINX AXU2CGB](https://www.en.alinx.com/Product/SoC-Development-Boards/Zynq-UltraScale-plus-MPSoC/AXU2CGB.html).
   
### 2. Реализовать поддержку USB 1.0 в KarnixSoC

Цель: подключение к СнК устройств ввода: клавиатура, мышь, геймпад.

  2.1. Интегрировать проект [usb_hid_host](https://github.com/nand2mario/usb_hid_host) от  hi631 (Hiromichi Kitahara).

Работа по интерграции частично выполнена, однако из-за отсустствия возможности точно генерировать тактовый сингал 12.0 МГц для USB блока, возникают бит-слипы и данные приходят со смещением ("битые" пакеты). Из-за отсуствия в usb_hid_host проверки CRC, детектировать такие сбойные пакеты не представляется возможным. Отсюда апрашивается два решение:

  2.1.1. Усовершенстсовать проект usb_hid_host: улучшить синхронизацию, добавить проверку CRC.
  
  2.1.2. Переосмыслить и переписать usb_hid_host на SpinalHDL: сделать базовой тактовой частотой не 12 МГц, а частоту ядра 60 МГц; использовать повышенную частоту для более плавной адаптации к несущей частоте (улучшить SYNC).

### 3. Реализовать аудио-кодек PCM16->I2S

Цель: формирование цифрового звукового сигнала совместимого с современными аудио-системами.

Устройство во входном FIFO принимает поток 16-ти битных сэмплов с чередованием каналов левый/правый и формирует на выходе последовательный 32-х битный поток в формате I2S.

## Список задач по расширению программных возможностей СнК "Карно"

### 1. Программа Karnix Bootloader

Добавить возможность выбора приложения, подлежащего запуску, находящегося во внешней NOR flash памяти. Просканировать предопределенные точки входа на предмет наличия приложения (определяется по Magic) и предложить пользователю через UART и/или видео-терминал выбрать одно из них. Если пользователь не реагирует в течении 3 сек, запускать приложегние по-умолчанию.

### 2. Программа Karnix Monitor

  2.1. Добавить поддержку видео-терминала (клавиатура+CGA дисплей) для взаимодействия с пользователем.
  
  2.2. Добавить простейший диассемблер (команда **disas**).

### 3. Добавить HAL для работы с внешним АЦП ADC128S052

Добавить еще один аппаратный блок SPI с входным FIFO. Описать HAL и реализовать пример захвата (оцифровки) данных с одного из входных портов АЦП.

### 4. Адаптировать операционную систему Xv6

Учебная Unix-подобная ОС Xv6 разработана Робертом Моррисом из MIT и предназначена для обучения студентов основам системного программирования. Данная ОС уже портирована на архитектуру RISC-V (RV64I и RV32I). Необходимо адаптировать ОС для СнК "Карно", в том числе:

  4.1. Решить вопрос с распределением памяти и таблицы страниц (page table).
  
  4.2. Написать драйвер последовательного порта (UART).
  
  4.3. Написать драйвер для достапу к NOR flash как к внешнему носителю.
  
  4.4. Адаптировать файловую систему для NOR flash.

- Ссылка на Xv6 на сайте MIT: https://pdos.csail.mit.edu/6.828/2012/xv6.html
- Перевод на русский на Хабре: https://habr.com/ru/articles/789478/
- Ссылка на пепозиторий: https://github.com/michaelengel/xv6-rv32

